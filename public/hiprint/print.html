<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>æ‰“å°è®¾è®¡</title>
    <link rel="stylesheet" href="./assets/fonts/bootstrap-icons.css" />
    <link rel="stylesheet" href="./lib/element-plus.css" />
    <link rel="stylesheet" href="./assets/css/hiprint.css" />
    <link rel="stylesheet" href="./assets/css/print-lock.css" />
    <link rel="stylesheet" href="./assets/css/design.css" />

    <script src="./lib/vue3.prod.js"></script>
    <script src="./lib/element-plus.js"></script>

    <script src="./plugins/jquery@1.11.3.min.js"></script>
    <script src="./polyfill.min.js"></script>
    <script src="./plugins/jquery.minicolors.min.js"></script>
    <script src="./plugins/JsBarcode.all.min.js"></script>
    <script src="./plugins/qrcode.js"></script>
    <!-- <script src="./plugins/socket.io.js"></script> -->
    <script src="./utils/watermark.js"></script>
    <script src="./hiprint.bundle.js"></script>
    <script src="./plugins/jquery.hiwprint.js"></script>
    <script src="./plugins/jspdf/canvas2image.js"></script>
    <script src="./plugins/jspdf/canvg.min.js"></script>
    <script src="./plugins/jspdf/html2canvas.min.js"></script>
    <script src="./plugins/jspdf/jspdf.min.js"></script>

    <script src="./utils/config-etype-provider.js"></script>
    <script src="./utils/design.js"></script>
    <script src="./utils/template.js"></script>
    <script src="./utils/component.js" defer></script>
  </head>

  <body>
    <div id="app"></div>

    <script type="text/html" id="designTemplate">
      <el-container class="w-100 h-100">
        <el-header style="height: 50px; line-height: 50px; padding: 0 10px">
          <MyHeader ref="tableRef" @updateTemplate="onUpdateTemplate" />
        </el-header>
        <el-container class="h-100 ui-ov-h border" style="margin: 0 10px">
          <el-aside width="200px" class="ui-ovy-a p-10">
            <div class="rect-printElement-types hiprintEpContainer">
              <!-- æ‹–æ‹½åˆ—è¡¨ -->
              <ul class="hiprint-printElement-type">
                <li v-for="item in elements">
                  <span class="title">{{item.title}}</span>
                  <ul>
                    <li v-for="cell in item.children">
                      <a class="ep-draggable-item" :tid="cell.tid">
                        <span class="glyphicon" :class="cell.icon"></span>
                        <span class="glyphicon-class" title="æ–‡æœ¬">{{cell.title}}</span>
                      </a>
                    </li>
                  </ul>
                </li>
              </ul>
            </div>
          </el-aside>
          <el-main class="h-100 border-left border-right flex-col" style="padding: 0">
            <div class="tool-buttons" style="margin: 8px 0 5px 8px">
              <!-- å·¥å…·æŒ‰é’® -->
              <MyTool ref="toolRef" @resetDesign="onResetDesign" @updateDesign="onUpdateDesign">
            </div>
            <div class="h-100 flex-1 print-scroll-wrap">
              <!-- è®¾è®¡åŒºåŸŸ -->
              <div id="designer"></div>
            </div>
          </el-main>
          <el-aside width="20%" style="min-width: 280px; overflow-y: auto">
            <!-- å±æ€§é…ç½® -->
            <div id="PrintElementOptionSetting"></div>
          </el-aside>
        </el-container>
        <el-footer class="footer">
          <div class="flex-between">
            <span>æ¨¡æ¿åç§°: {{templateName}}</span>
            <span> HiPrint Designer V2.5.4</span>
          </div>
        </el-footer>
      </el-container>
    </script>

    <script type="text/html" id="headerTemplate">
      <div class="flex-between">
        <div class="fz-22 color-blue">æ‰“å°è®¾è®¡</div>
        <span>
          <span @click="onOpenNew" title="æ–°çª—å£é¢„è§ˆ" class="fz-22 pointer mr-10">â‡ï¸</span>
          <span @click="docVisible = true" title="æ‰“å°é…ç½®" class="fz-22 pointer mr-10">ğŸ””</span>
          <el-popover class="box-item" :title="`æ¨¡æ¿åˆ—è¡¨(${tableData.length})`" placement="bottom-end" width="360px" trigger="click">
            <template #reference>
              <span title="æ¨¡æ¿åˆ—è¡¨" class="fz-22 pointer color-f60">â“‚ï¸</span>
            </template>
            <el-table :data="tableData" row-key="name" @current-change="onCurrentChange" style="width: 100%" size="small" max-height="300" border highlight-current-row empty-text="æš‚æ— æ•°æ®">
              <el-table-column label="æ¨¡æ¿åç§°" prop="name" show-overflow-tooltip />
              <el-table-column label="åˆ›å»ºæ—¶é—´" prop="createDate" width="130" />
              <el-table-column label="æ“ä½œ"  width="70">
                <template #default="{ row }">
                  <el-button type="danger" size="small" @click.stop="onDelete(row)">åˆ é™¤</el-button>
                </el-table-column>
            </el-table>
          </el-popover>
        </span>
      </div>
      <el-dialog v-model="docVisible" title="æ‰“å°é…ç½®" width="50%" top="5vh">
        <el-input v-model="docText" spellcheck="false" type="textarea" style="width: 100%;line-height: 22px;" rows="20" readonly placeholder="æš‚æ— æ•°æ®" />
        <template #footer>
          <div class="dialog-footer">
            <el-button @click="docVisible = false">å–æ¶ˆ</el-button>
          </div>
        </template>
      </el-dialog>
    </script>

    <script type="text/html" id="toolTemplate">
      <div class="buttons">
        <span v-for="item in toolButtons">
          <span v-if="['widthInput', 'heightInput'].includes(item.action) ">
            <el-input
              v-model.number="formData[item.action]"
              :placeholder="item.action === 'widthInput' ? 'å®½/mm' : 'é«˜/mm'"
              size="small"
              class="mb-8 mr-8"
              style="width: 50px"
            />
          </span>
          <span v-else-if="['scaleInput'].includes(item.action) ">
            <el-popover class="box-item" placement="bottom" width="120px" trigger="hover">
              <template #reference>
                <el-input
                  v-model.number="formData.scale"
                  placeholder="100%"
                  readonly
                  size="small"
                  :title="item.title"
                  @click="onResetScale"
                  class="scale-input mb-8 mr-8"
                  style="width: 50px;"
                />
              </template>
              <el-slider
                v-model="scaleValue"
                :show-tooltip="false"
                :step="drawDef.step"
                :min="drawDef.min"
                :max="drawDef.max"
                :debounce="0"
                size="small"
                @input="setScale"
              />
              <div class="drag-panel">ç‚¹å‡»æ‹–æ‹½ç”»å¸ƒ</div>
            </el-popover>
          </span>
          <el-button
            v-else
            size="small"
            :title="item.title"
            :type="getType(item)"
            @click="onSetSize(item)"
            class="mb-8 mr-8"
            style="margin-left: auto; margin-right: 8px"
          >
            <template #default="row">
              <span v-if="item.action !== 'more'">{{item.name}}</span>
              <el-dropdown v-else>
                <span :style="{  color: isMore ? '#fff' : '', outline: 'none'}">
                  <span class="ui-va-t">{{item.name}} </span>
                  <el-icon class="el-icon--right">
                    <svg data-v-ec522aeb="" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024">
                      <path
                        fill="currentColor"
                        d="M831.872 340.864 512 652.672 192.128 340.864a30.592 30.592 0 0 0-42.752 0 29.12 29.12 0 0 0 0 41.6L489.664 714.24a32 32 0 0 0 44.672 0l340.288-331.712a29.12 29.12 0 0 0 0-41.728 30.592 30.592 0 0 0-42.752 0z"
                      ></path>
                    </svg>
                  </el-icon>
                </span>
                <template #dropdown>
                  <el-dropdown-menu>
                    <el-dropdown-item
                      v-for="cell in item.children"
                      :key="cell.name"
                      :divided="cell.divided"
                      :title="cell.title"
                      :style="{ color: active === cell.action ? '#fff' : '', background: active === cell.action ? '#95d475' : '' }"
                      @click="onSetSize(cell, true)"
                    >
                      {{ cell.name }}
                    </el-dropdown-item>
                  </el-dropdown-menu>
                </template>
              </el-dropdown>
            </template>
          </el-button>
        </span>
      </div>
      <div class="hiprint-printPagination"></div>
      <!-- æ‰“å°é¢„è§ˆ -->
      <el-dialog v-model="printVisible" title="æ‰“å°é¢„è§ˆ" width="fit-content" top="5vh">
        <div class="dialog-body" style="max-height: 75vh; overflow-y: auto">
          <div class="prevViewDiv"></div>
        </div>
        <template #footer>
          <div class="dialog-footer">
            <el-button @click="printVisible = false">å–æ¶ˆ</el-button>
            <el-button type="success" @click="onExportPdf">PDF</el-button>
            <el-button type="primary" @click="onPrint">æ‰“å°</el-button>
          </div>
        </template>
      </el-dialog>

      <!-- é…ç½®å¼¹çª— -->
      <el-dialog v-model="dialogVisible" draggable title="æ¨¡æ¿é…ç½®" width="40%" top="4vh">
        <el-form :model="tplForm" label-width="0px" inline>
          <el-form-item style="margin-bottom: 0px">
            <el-checkbox v-model="tplForm.compress" @change="(v)=>onTplChange('compress', v)">å‹ç¼©é…ç½®</el-checkbox>
          </el-form-item>
          <el-form-item style="margin-bottom: 0px">
            <el-checkbox v-model="tplForm.disabled" @change="(v)=>onTplChange('disabled', v)">ç¦ç”¨æ‹–æ‹½</el-checkbox>
          </el-form-item>
          <div>
            <el-form-item style="width: 100%">
              <el-input
                v-model="tplForm.content"
                type="textarea"
                style="width: 100%"
                input-style="height: calc(100vh - 266px)"
                resize="none"
                placeholder="æš‚æ— æ•°æ®"
              />
            </el-form-item>
          </div>
        </el-form>
        <template #footer>
          <div class="dialog-footer">
            <el-button @click="dialogVisible = false">å…³é—­</el-button>
            <el-button type="warning" @click="onSave">ä¿å­˜</el-button>
            <el-button type="success" @click="onRewirite">ä¿®æ”¹</el-button>
            <el-button type="primary" @click="onCopy">å¤åˆ¶</el-button>
          </div>
        </template>
      </el-dialog>
    </script>

    <script>
      const { ElMessage, ElMessageBox } = ElementPlus;
      const { createApp, defineComponent, ref, onMounted, reactive, computed } = Vue;
      const { setPaperSize, onPrint, onRotate, onClear, onGridLine, onResetScale, isIframe } = Design;

      var isPress = false; // å…¨å±€å˜é‡
      var printConfig = {};
      var hiprintTemplate = null;
      const tableRef = ref();
      const active = ref(null);
      const scaleValue = ref(1);
      const templateName = ref("");
      const printVisible = ref(false);
      const btnActive = reactive({ isGrid: false, isRotate: false });
      const formData = reactive({ heightInput: "", widthInput: "", scale: "100%" });

      window.onload = () => {
        const App = defineComponent({
          name: "App",
          template: genTemplate("designTemplate"),
          setup(props, {}) {
            onMounted(() => {
              if (isIframe()) {
                // åœ¨iframeä¸­æ‰“å¼€, ç›‘å¬æ¶ˆæ¯
                window.addEventListener("message", onMessageOnce);
              } else {
                // å•ç‹¬æ‰“å¼€æ—¶, æ–°å»ºç©ºæ¨¡æ¿
                onInitHiPrint(defaultConfig);
              }
            });

            /** ç›‘å¬æ¶ˆæ¯ åˆå§‹åŒ–æ•°æ®æ¨¡æ¿ */
            const onMessageOnce = (ev) => {
              const { type, data } = ev.data;
              if (type !== "HiPrint") return;
              onInitHiPrint(data);
              window.removeEventListener("message", onMessageOnce);
            };

            // é‡ç½®æ•°æ®æ¨¡æ¿
            function onResetDesign() {
              onInitHiPrint(printConfig);
            }

            // ä¿®æ”¹æ•°æ®æ¨¡æ¿
            function onUpdateDesign(data) {
              onInitHiPrint(data);
            }

            /** åˆ›å»ºæ¨¡æ¿ */
            function onInitHiPrint(data = {}) {
              const options = Object.assign({}, defaultConfig, data);
              const { title, size, printType, showLandscape, showGridLine, template, testData } = options;
              templateName.value = title;
              printConfig = options;

              // 1.è‡ªåŠ¨åˆ†é¡µå¤„ç†
              if (printType === "auto" && Array.isArray(template.panels)) {
                options.template.panels.forEach((f, index) => {
                  f.paperType = size;
                  let _testData = testData;
                  if (Array.isArray(testData)) _testData = testData[index] || {};
                  f.printElements.forEach((el) => {
                    const { field } = el.options || {};
                    if (!field) return;
                    const { type } = el.printElementType;
                    let value = _testData[field];
                    if (value && type === "image") el.options.src = value;
                    else if (value && field) el.options.testData = value;
                  });
                });
              }
              // 2.å›ºå®šåˆ†é¡µå¤„ç†
              function fixed() {
                onCreateFixedPage(data);
              }

              createTemplate(options)
                .then(() => {
                  setPaperSize(size);
                  const printHander = { fixed };
                  printHander[printType]?.();
                  const { showPrint } = getQuery(location.href);
                  if (showGridLine) {
                    btnActive.isGrid = true;
                    onGridLine(true);
                  }
                  if (showLandscape) {
                    btnActive.isRotate = true;
                    onRotate();
                  }
                  if (showPrint === "true") onPrint();
                })
                .catch((err) => console.error("æ¨¡æ¿åˆå§‹åŒ–å¤±è´¥", err));
            }

            // æ–°å¢ã€ç§»åŠ¨ã€åˆ é™¤ã€ä¿®æ”¹(å‚æ•°è°ƒæ•´)ã€å¤§å°ã€æ—‹è½¬
            function onDataChanged(type, json) {
              console.log(type, json);
            }

            /** åˆ›å»ºæ¨¡æ¿ */
            function createTemplate(options = {}) {
              const { template, showGridLine, dataMode, history, fontList, onDataChange = onDataChanged } = options;
              return new Promise((resolve) => {
                $("#designer").html("");
                //åˆå§‹åŒ–æ‰“å°æ’ä»¶
                hiprint.init({ providers: [new customElementTypeProvider()] });
                //è®¾ç½®å·¦ä¾§æ‹–æ‹½äº‹ä»¶
                hiprint.PrintElementTypeManager.buildByHtml($(".ep-draggable-item"));
                hiprintTemplate = new hiprint.PrintTemplate({
                  template: template,
                  fontList: fontList,
                  dataMode: dataMode,
                  gridLine: showGridLine,
                  history: history,
                  onDataChange: onDataChange,
                  settingContainer: "#PrintElementOptionSetting",
                  paginationContainer: ".hiprint-printPagination",
                });
                hiprintTemplate.design("#designer"); // æ¸²æŸ“è®¾è®¡å™¨
                requestAnimationFrame(() => resolve());
              });
            }

            // å›ºå®šåˆ†é¡µå†…å®¹
            function onCreateFixedPage(data) {
              const { pages, isAllPaper, showLandscape } = data;
              const defaultPanelHeight = 297; // mm
              const _pages = pages.filter((f) => !(f.pageHeader || f.pageFooter));
              const _papers = pages.filter((f) => f.pageHeader || f.pageFooter);

              // æ·»åŠ é¡µçœ‰é¡µè„š
              function addHeaderFooter(_papers, panel, isLastPage = false) {
                _papers.forEach((f) => {
                  if (f.pageHeader) addElement(f.elements, panel); // é¡µçœ‰
                  if (f.pageFooter && isLastPage) addElement(f.elements, panel); // é¡µå°¾
                });
              }
              // éå†æ•°æ®ç”Ÿæˆæ¯ä¸€é¡µ
              _pages.forEach((item, index) => {
                // æ·»åŠ åˆ†é¡µ
                if (index > 0) {
                  hiprintTemplate.addPrintPanel({
                    height: showLandscape ? 210 : defaultPanelHeight,
                    width: showLandscape ? defaultPanelHeight : 210,
                    paperNumberDisabled: true,
                    paperNumberFormat: "paperNo-paperCount",
                    pageBreak: index < _pages.length - 1,
                  });
                }
                const panel = hiprintTemplate.getPanel(index); // è·å–å½“å‰é¡µ
                addHeaderFooter(_papers, panel, isAllPaper || index === _pages.length - 1);
                addElement(item.elements, panel);
              });
              hiprintTemplate.design("#designer");
            }

            /** æ·»åŠ å…ƒç´  */
            function addElement(elements = [], panel) {
              elements.forEach(({ method, templateType, testData, options }) => {
                if (templateType === "table") options.content = createPrint(testData).outerHTML;
                panel[method]({ options });
              });
            }

            /** é€‰ä¸­åˆ—è¡¨æ¨¡æ¿ */
            function onUpdateTemplate(row) {
              onInitHiPrint(row.content);
            }

            return {
              tableRef,
              templateName,
              elements,
              papers,
              toolButtons,
              printVisible,
              onResetScale,
              onInitHiPrint,
              onResetDesign,
              onUpdateDesign,
              onUpdateTemplate,
            };
          },
        });
        const app = createApp(App);
        app.use(ElementPlus);
        registerComponents(app);
        app.mount("#app");
      };
    </script>
  </body>
</html>
